<template>
  <div>
     <bk-compose-form-item class="select-demo">
       <div>&nbsp;</div>
        <bk-select v-model="value1" style="width: 140px" size="large" :clearable="false">
          <bk-option id="id" name="学号" @click="option_id"></bk-option>
          <bk-option id="name" name="姓名" @click="option_name"></bk-option>
          <bk-option id="content" name="简介" @click="option_content"></bk-option>
          <bk-option id="year" name="届号" @click="option_year"></bk-option>
          <bk-option id="college_name" name="学院名称" @click="option_college_name"></bk-option>
          <bk-option id="major_name" name="专业名称" @click="option_major_name"></bk-option>
          <bk-option id="grade_number" name="班级号" @click="option_grade_number"></bk-option>
          <bk-option id="grade_id" name="班级ID" @click="option_grade_id"></bk-option>
        </bk-select>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'id'" key:1 placeholder="请输入学号" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'name'" key:4 placeholder="请输入姓名" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'content'" key:4 placeholder="请输入简介" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'year'" key:2 placeholder="请输入届号" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'college_name'" key:3 placeholder="请输入学院名称" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'major_name'" key:4 placeholder="请输入专业名称" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'grade_number'" key:1 placeholder="请输入班级号" :left-icon="'bk-icon icon-search'"></bk-input>
        <bk-input style="width: 400px" size="large" v-model=textcontent v-if="value1 === 'grade_id'" key:4 placeholder="请输入班级ID" :left-icon="'bk-icon icon-search'"></bk-input>
       <bk-button type="search" theme="warning" @click="search_data" size="large">search</bk-button>
     </bk-compose-form-item>
     <div style="float:right;" class="container">
      <div>&nbsp;</div>
      <bk-button theme="primary" @click="toggleTableSize">样式设置</bk-button>
      <span class="ml10">当前尺寸：{{ size }} &nbsp;&nbsp;&nbsp;</span>
      <div>&nbsp;</div>
      <div class="inner">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <bk-popconfirm trigger="click" :ext-cls="'asadsadsads'" width="288" @confirm="addData()">
          <div slot="content">
              <bk-compose-form-item>
                <h3>学号: <bk-input v-model='create_id' type='text'/></h3>
                <h3>姓名: <bk-input v-model='create_name' type='text'/></h3>
                <h3>简介: <bk-input v-model='create_content' type='text'/></h3>
                <h3>班级ID: <bk-input v-model='create_grade_id' type='text'/></h3>
              </bk-compose-form-item>
          </div>
          <bk-button theme="primary" :disabled="status === 'USER'">添加</bk-button>
        </bk-popconfirm>
      </div>
      &nbsp;
    </div>
    <div style="float:left;">
      <div>&nbsp;</div>
      <div>&nbsp;</div>
      <div>&nbsp;</div>
      <div>&nbsp;</div>
      &nbsp;<bk-icon type="upload" />&nbsp;<bk-button theme="success" @click="load_excel()"> 数据导出</bk-button>
    </div>
    <bk-table style="margin-top: 15px;"
        :data="page_data"
        :size="size"
        :pagination="pagination"
        @page-change="handlePageChange"
        @page-limit-change="handlePageLimitChange"
        @select="curSelected"
        @select-all="curAllSelected">
      <bk-table-column type="selection" width="60"></bk-table-column>  <!--可选的地方-->
      <bk-table-column type="index" label="序列" width="60"></bk-table-column>
      <bk-table-column label="学号" prop="id"></bk-table-column>
      <bk-table-column label="姓名" prop="name"></bk-table-column>
      <bk-table-column label="简介" prop="content"></bk-table-column>
      <bk-table-column label="届号" prop="year"></bk-table-column>
      <bk-table-column label="学院名称" prop="college_name"></bk-table-column>
      <bk-table-column label="专业名称" prop="major_name"></bk-table-column>
      <bk-table-column label="班级号" prop="grade_number"></bk-table-column>
      <bk-table-column label="班级ID" prop="grade_id"></bk-table-column>
      <bk-table-column label="操作" width="150">
        <template slot-scope="props">
          <bk-popconfirm trigger="click" :ext-cls="'asadsadsads'" width="288"
                         @confirm="changeData(props.row.id, props.row.grade_id)">
              <div slot="content">
                  <bk-compose-form-item>
                    <h3>学号: <bk-input v-model="props.row.id" type='text' disabled="true"/></h3>
                    <h3>姓名: <bk-input v-model="update_name" type='text'/></h3>
                    <h3>简介: <bk-input v-model="update_content" type='text'/></h3>
                    <h3>届号: <bk-input v-model="update_year" type='text'  disabled="true"/></h3>
                    <h3>学院名称: <bk-input v-model="update_college_name" type='text' disabled="true"/></h3>
                    <h3>专业名称: <bk-input v-model="update_major_name" type='text' disabled="true"/></h3>
                    <h3>班级号: <bk-input v-model="update_grade_number" type='text' disabled="true"/></h3>
                    <h3>班级ID: <bk-input v-model="update_grade_id" type='text'/></h3>
                  </bk-compose-form-item>
              </div>
              <bk-button class="mr10" theme="primary" text :disabled="status === 'USER'" @click=
                "update_init(props.row.name, props.row.content, props.row.year, props.row.college_name,
                props.row.major_name, props.row.grade_number, props.row.grade_id)">修改</bk-button>
          </bk-popconfirm>
          <bk-popconfirm trigger="click" :ext-cls="'asadsadsads'" width="288"
                         @confirm="removeData(props.row.id)">
              <div slot="content">
                  <div class="demo-custom">
                      <i class="bk-icon icon-info-circle-shape pr5 content-icon"></i>
                      <div class="content-text">确认删除？一旦删除不可回滚</div>
                  </div>
              </div>
              <bk-button class="mr10" theme="primary" text :disabled="status === 'USER'">删除</bk-button>
          </bk-popconfirm>
          <bk-popover class="dot-menu" placement="bottom-start" theme="dot-menu light"
                      :trigger="props.$index % 2 === 0 ? 'click' : 'mouseenter'" :arrow="false" offset="200"
                      :distance="0">
            <span class="dot-menu-trigger"></span>
          </bk-popover>
        </template>
      </bk-table-column>
    </bk-table>
  </div>
</template>

<script>
import {bkTable, bkTableColumn, bkButton, bkPopover, bkComposeFormItem, bkInput, bkSelect, bkOption, bkColorPicker,
  bkIcon, bkPopconfirm} from 'bk-magic-vue'
import axios from 'axios'
import {host} from '../../static/js/host'

export default {
  name: 'student',
  components: {
    bkTable,
    bkTableColumn,
    bkButton,
    bkPopover,
    bkComposeFormItem,
    bkInput,
    bkSelect,
    bkOption,
    bkColorPicker,
    bkIcon,
    bkPopconfirm
  },
  data () {
    return {
      textcontent: '', // 搜索框输入内容
      size: 'small',
      data: [
        {
          id: '3120006969',
          name: '啊捶',
          content: '很好',
          year: '2020',
          college_name: '数学与统计学院',
          major_name: '信息与计算科学',
          grade_number: '3',
          grade_id: '2'
        },
        {
          id: '3120006900',
          name: '小明',
          content: '呃呃',
          year: '2020',
          college_name: '数学与统计学院',
          major_name: '信息与计算科学',
          grade_number: '4',
          grade_id: '3'
        }
      ],
      page_data: [], // 用于展示
      pagination: {
        current: 1, // 首页
        count: 0, // 总数
        limit: 10 // 限制
      },
      page_data: [],
      value1: 'id',
      token: localStorage.token || sessionStorage.token,
      username: localStorage.username || sessionStorage.username,
      status: sessionStorage.status,
      update_name: '',
      update_content: '',
      update_year: '',
      update_college_name: '',
      update_major_name: '',
      update_grade_number: '',
      update_grade_id: '',
      create_id: '',
      create_name: '',
      create_content: '',
      create_grade_id: '',
      cur_getData: true,
      select_list: [], // 判断是否被选中的列表，被点后全部实时更新
      select_list_all: false // 判断是否被全选
    }
  },
  mounted () {
    this.getData()
  },
  methods: {
    getData () {
      axios.get(host + '/student/', { // 获取data列表中的数据
        headers: {
          'Authorization': 'Bearer ' + this.token
        },
        responseType: 'json'
      }).then(response => {
        console.log('学生信息' + response.data)
        this.data = response.data.student // 列表的数据和data是绑一起的
        this.pagination['count'] = this.data.length
        console.log("学生信息获取成功" + this.data.length)
        this.cur_getData = true

        this.getPageData()
      })
        .catch(error => {
          console.log(error.response.data)
        })
    },
    getPageData () { // 分页操作显示列表
      this.page_data = []
      let start = (this.pagination.current - 1) * this.pagination.limit
      for (let i = start; i < this.pagination.current * this.pagination.limit  && i < this.pagination.count; i++) {
          this.page_data.push(this.data[i]);
      }
    },
    addData () {
      if (this.create_id && this.create_name && this.create_content && this.create_grade_id) {
        axios.post(host + '/student/', JSON.parse(JSON.stringify(
          {
            'id': this.create_id,
            'name': this.create_name,
            'content': this.create_content,
            'grade_id': this.create_grade_id
          })), {
          headers: {
            'Authorization': 'Bearer ' + this.token
          },
          responseType: 'json'
        }).then(response => {
          this.data.push({
            'id': this.create_id,
            'name': this.create_name,
            'content': this.create_content,
            'year': response.data.year,
            'college_name': response.data.college_name,
            'major_name': response.data.major_name,
            'grade_number': response.data.grade_number,
            'grade_id': this.create_grade_id
          })
        }).catch(error => {
          alert(error.response.data.message)
          console.log(error.response.data.message)
        })
      } else {
        this.errorInfoBox('不能存在输入为空')
      }
    },
    changeData (id, grade_id) {
      var a = '1'
      if (grade_id !== this.update_grade_id) {
        a = '2'
      }
      if (this.update_name && this.update_grade_id && this.update_content) {
        axios.put(host + '/student/' + id + '/', JSON.parse(JSON.stringify(
          {
            'id': id,
            'name': this.update_name,
            'content': this.update_content,
            'year': this.update_year,
            'college_name': this.update_college_name,
            'major_name': this.update_major_name,
            'grade_number': this.update_grade_number,
            'grade_id': this.update_grade_id,
            'change_grade_id': a
          })), {
          headers: {
            'Authorization': 'Bearer ' + this.token
          },
          responseType: 'json'
        }).then(response => {
          for (let i = 0; i < this.data.length; i++) {
            if (this.data[i].id === id) { // 修改
              this.data[i].name = this.update_name
              this.data[i].content = this.update_content
              this.data[i].grade_id = this.update_grade_id
              if (a === '2') {
                this.data[i].year = response.data.year
                this.data[i].college_name = response.data.college_name
                this.data[i].major_name = response.data.major_name
                this.data[i].grade_number = response.data.grade_number
              } else {
                this.data[i].year = this.update_year
                this.data[i].college_name = this.update_college_name
                this.data[i].major_name = this.update_major_name
                this.data[i].grade_number = this.update_grade_number
              }
              break
            }
          }
        }).catch(error => {
          alert(error.response.data.message)
          console.log(error.response.data.message)
        })
      } else {
        this.errorInfoBox('不能存在输入为空')
      }
    },
    update_init(name, content, year, college_name, major_name, grade_number, grade_id) {
      this.update_name = name
      this.update_content = content
      this.update_year = year
      this.update_college_name = college_name
      this.update_major_name = major_name
      this.update_grade_number = grade_number
      this.update_grade_id = grade_id
    },
    removeData (id) {
      // 删除数据
      axios.delete(host + '/student/' + id + '/', {
        headers: {
          'Authorization': 'Bearer ' + this.token
        },
        responseType: 'json',
        params: {id: id}
      }).then(response => {
        for (let i = 0; i < this.data.length; i++) {
          if (this.data[i].id === id) { // 从数组中移除地址
            this.data.splice(i, 1)
            break
          }
        }
      }).catch(error => {
        console.log(error.response.data)
      })
    },
    search_data () { // 通过v-model绑定的textcontent获取文本内容，通过下滑框对应的value1获取下拉框选择的对象  搜索数据
      if (!this.textcontent) {
        this.handleSingle('欢迎使用GDUT DBA', '龙洞小助手提醒您搜索内容请有所输入，否则还是原信息')
        if (!this.cur_getData) {
          this.getData()
        }
      } else {
        let param = ''
        if (this.value1 === 'id') {
          param = {id: this.textcontent}
        } else if (this.value1 === 'name') {
          param = {name: this.textcontent}
        } else if (this.value1 === 'content') {
          param = {content: this.textcontent}
        } else if (this.value1 === 'year') {
          param = {year: this.textcontent}
        } else if (this.value1 === 'college_name') {
          param = {college_name: this.textcontent}
        } else if (this.value1 === 'major_name') {
          param = {major_name: this.textcontent}
        } else if (this.value1 === 'grade_number') {
          param = {grade_number: this.textcontent}
        } else if (this.value1 === 'grade_id') {
          param = {grade_id: this.textcontent}
        } else {
          alert('操作客户端变量被篡改的风险，请刷新页面')
        }

        axios.get(host + '/student/search/', { // 获取data列表中的数据
          headers: {
            'Authorization': 'Bearer ' + this.token
          },
          responseType: 'json',
          params: param
        }).then(response => {
          console.log('筛选的班级信息：' + response.data)
          this.data = response.data.student // 列表的数据和data是绑一起的
          this.cur_getData = false
          this.pagination['count'] = this.data.length
          this.getPageData()
        })
          .catch(error => {
            console.log(error.response.data)
          })
      }
    },
    load_excel () { // JSON格式
      if (!this.select_list_all && this.select_list == null) {
        return
      }
      this.to_excel(this.select_list_all ? this.data : this.select_list)
    },
    to_excel (data) { // 转化成excel
      let str = '<tr><td>学号</td><td>姓名</td><td>简介</td><td>届号</td><td>学院名称</td><td>专业名称</td><td>班级号</td>' +
        '<td>班级ID</td></tr>' // 列标题
      // 循环遍历，每行加入tr标签，每个单元格加td标签
      for (let i = 0; i < data.length; i++) {
        str += '<tr>'
        for (const key in data[i]) { // 增加' '为了不让表格显示科学计数法或者其他格式
          str += '<td>' + data[i][key] + ' ' + '</td>'
        }
        str += '</tr>'
      }
      const worksheet = 'Sheet1' // Worksheet名
      const uri = 'data:application/vnd.ms-excel;base64,'

      // 下载的表格模板数据
      const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns="http://www.w3.org/TR/REC-html40">
      <head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
      <x:Name>${worksheet}</x:Name>
      <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
      </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
      </head><body><table>${str}</table></body></html>`
      // 下载模板
      window.location.href = uri + window.btoa(unescape(encodeURIComponent(template))) // +后是编码
    },
    option_id () { // 根据下化框选择学院
      this.value1 = 'id'
    },
    option_name () {
      this.value1 = 'name'
    },
    option_content () {
      this.value1 = 'content'
    },
    option_year () {
      this.value1 = 'year'
    },
    option_college_name () {
      this.value1 = 'college_name'
    },
    option_major_name () {
      this.value1 = 'major_name'
    },
    option_grade_number () {
      this.value1 = 'grade_number'
    },
    option_grade_id () {
      this.value1 = 'grade_id'
    },
    toggleTableSize () { // 调整尺寸函数
      const size = ['small', 'medium', 'large']
      const index = (size.indexOf(this.size) + 1) % 3
      this.size = size[index]
    },
    handlePageChange (page) { // 回调当前页
      this.pagination.current = page
      this.getPageData()
      // console.log(this.pagination.current)
    },
    handlePageLimitChange () { // 当用户切换表格每页显示条数时会出发的事件
      console.log('handlePageLimitChange', arguments)
      this.pagination.limit = arguments[0]
      this.getPageData()
    },
    curSelected (selection, row) { // 根据文档提示的回调函数及对应参数，（selection, row）其中row就可以把选中行所有数据取出来，但我们这里只需要从data把值该位selected
      console.log(selection)
      this.select_list = []
      for (let i = 0; i < selection.length; i++) {
        this.select_list.add(selection[i])
      }
    },
    curAllSelected (selection) { // 点首栏的选择全部才会进入这里
      this.select_list = [] // 清空select_list_id，以防突然地不勾选或勾选
      this.select_list_all = selection.length > 0
      console.log(selection)
      console.log(selection.length)
      console.log(this.select_list_all)
    },
    errorInfoBox (msg) {
      const a = this.$bkInfo({
        type: 'error',
        title: 'Fail:' + msg,
        subTitle: '窗口2秒后关闭',
        showFooter: false
      })
      let num = 2
      let t = setInterval(() => {
        a.subTitle = `此窗口${--num}秒后关闭`
        if (num === 0) {
          clearInterval(t)
          a.close()
        }
      }, 1000)
    },
    handleSingle (title, message) {
      let msg = {theme: 'warning'}
      msg.title = title
      msg.message = message
      msg.offsetY = 80
      msg.limitLine = 3
      this.$bkNotify(msg)
    }
  }
}
</script>

<style>
.demo-custom {
    font-size: 14px;
    line-height: 24px;
    color: #63656e;
    padding-bottom: 10px;
}
.content-icon {
    color: #ea3636;
    position: absolute;
    top: 20px;
}
.content-text {
    display: inline-block;
    margin-left: 20px;
}

.dot-menu {
    display: inline-block;
    vertical-align: middle;
}
.dot-menu-trigger {
    display: block;
    width: 30px;
    height: 30px;
    line-height: 30px;
    border-radius: 50%;
    text-align: center;
    font-size: 0;
    color: #979BA5;
    cursor: pointer;
}
.dot-menu-trigger:hover {
    color: #3A84FF;
    background-color: #EBECF0;
}
.dot-menu-trigger:before {
    content: "";
    display: inline-block;
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background-color: currentColor;
    box-shadow: 0 -4px 0 currentColor, 0 4px 0 currentColor;
}
.dot-menu-list {
    margin: 0;
    padding: 5px 0;
    min-width: 50px;
    list-style: none;
}
.dot-menu-list .dot-menu-item {
    padding: 0 10px;
    font-size: 12px;
    line-height: 26px;
    cursor: pointer;
}
.dot-menu-list .dot-menu-item:hover {
    background-color: #eaf3ff;
    color: #3a84ff;
}
</style>
